AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Example SpringBoot application that writes in a DynamoTable

Parameters:
  ProjectId:
    Type: String
    Description: AWS CodeStar projectID used to associate new resources to team members
  Stage:
    Type: String
    Description: Deployment stage. E.g. test, prod, etc.
  CodeBucket:
    Type: String
    Description: S3 Bucket containing artifacts and source code.
    
    # Enable blue/green deployments using this Globals section. For instructions, see the AWS CodeStar User Guide:
    # https://docs.aws.amazon.com/codestar/latest/userguide/how-to-modify-serverless-project.html?icmpid=docs_acs_rm_tr
    #
    # Globals:
    #   Function:
    #     AutoPublishAlias: live
    #     DeploymentPreference:
    #       Enabled: true
    #       Type: Canary10Percent5Minutes



    #Globals:
    #  Api:
    # API Gateway regional endpoints
#    EndpointConfiguration: REGIONAL

Resources:
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      DefinitionBody:
        Fn::Transform:
          Name: 'AWS::Include'
          Parameters:
            Location: !Join ['', ['s3://', !Ref 'CodeBucket', '/openapi.yaml']]
  LambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: no.bibsys.handlers.StreamLambdaHandler::handleRequest
      Runtime: java8
      CodeUri: api/build/libs/api-fat.jar
      MemorySize: 1512
      #     Policies are inactive if there is a role attached to the lambda function
      #Policies:
      # - AWSLambdaBasicExecutionRole
      # - CustomDynamoDB_Full_Access
      Role:
        Fn::ImportValue:
          !Join ['-', [!Ref 'ProjectId', !Ref 'AWS::Region', 'LambdaTrustRole']]
      Timeout: 60
      Events:
        RootResource:
          Type: Api
          Properties:
            Path: /
            Method: any
            RestApiId: !Ref RestApi
        ApiResource:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: any
            RestApiId: !Ref RestApi

  RestApiUrlParameter:
    Type: "AWS::SSM::Parameter"
    Properties:
      Name: !Join ['-', [!Ref 'ProjectId', !Ref 'Stage', "apiUrl"]]
      Type: "String"
      Value: !Join ['', ['https://', !Ref 'RestApi', '.execute-api.', !Ref 'AWS::Region', '.amazonaws.com/', !Ref 'Stage']]
      Description: "SSM Parameter for storing RestApi URL"